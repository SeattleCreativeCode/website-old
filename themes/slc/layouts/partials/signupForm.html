<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function () {
  console.log("Attaching submit listener");
  document.getElementById("submit").addEventListener('click', submitHandler);
  document.getElementById("email").addEventListener('focus', clearError);
});

function displayError(e) {
  toggleLock(false);
  var field = document.getElementById("email");
  field.className = "error";
  field.placeholder = e;
  field.value = '';
}

function clearError() {
  document.getElementById("email").className = "";
}

function toggleLock(value) {
  document.querySelectorAll("input").forEach((e) => {
    e.disabled = value;
  });
}

function displaySuccess() {
  var success = document.createElement("div");
  success.className = "success";
  success.innerText = "Your request has been sent."
  var signup = document.getElementById("signup");
  signup.innerHTML = '';
  signup.appendChild(success);
}

function sendRequest(url, payload) {
  const PARAMS = {
    headers: {
      "content-type": "application/json; charset=UTF-8"
    },
    body: payload,
    method: "POST"
  };

  return fetch(url, PARAMS);
}

function validateEmail(email) {
  if (email.indexOf("@") < 0) {
    return "please enter a valid email address";
  }

  return true;
}

function submitHandler(e) {
  const URL = "{{ $.Site.Params.api_endpoint }}";
  console.log(URL); 
  e.preventDefault();
  var email = document.getElementById("email").value;
  if (!email) {
    displayError("email address is required");
    return;
  }
  const VALID = validateEmail(email);
  if (VALID !== true) {
    displayError(VALID);
    return;
  }

  const PAYLOAD = JSON.stringify({
    email
  });
  toggleLock(true);
  sendRequest(URL, PAYLOAD)
    .then(data => data.json())
    .then(res =>{displaySuccess()})
    .catch(e => displayError(e.toString()))
}
</script>